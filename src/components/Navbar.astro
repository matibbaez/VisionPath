---
// src/components/Navbar.astro
import Logo from './Logo.astro';
import LanguagePicker from './LanguagePicker.astro';
import { getLangFromUrl, useTranslations } from '../utils/i18n';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Detección de página
const currentPath = Astro.url.pathname;
const isCaseStudy = currentPath.includes('/case/');
const isHome = !isCaseStudy;

// Generador de links
const getLink = (hash: string) => {
  if (isHome) return hash; 
  return `/${lang}/${hash}`;
};

const navItems = [
  { name: t('nav.home'), label: "inicio", url: getLink("#home") },
  { name: t('nav.services'), label: "servicios", url: getLink("#servicios") },
  { name: t('nav.projects'), label: "proyectos", url: getLink("#proyectos") },
  { name: t('nav.solutions'), label: "soluciones", url: getLink("#soluciones") },
];
---

<header class="fixed top-0 left-0 right-0 z-50 flex justify-center pt-4 transition-all duration-300">
  
  <nav id="navbar" class="relative flex items-center justify-between px-6 py-3 w-[90%] max-w-4xl bg-black/60 border border-white/10 shadow-2xl backdrop-blur-xl rounded-full transition-all duration-700 ease-[cubic-bezier(0.25,0.1,0.25,1)]">
    
    <div class="z-10 flex items-center gap-4">
        <a href={isHome ? "#top" : `/${lang}/`} class="hover:scale-105 transition-transform">
            <Logo />
        </a>
        <div class="hidden md:block"><LanguagePicker /></div>
    </div>

    <div class="hidden md:block">
        <ul class="relative flex items-center bg-white/5 rounded-full p-1 border border-white/5">
            <div id="nav-indicator" class="absolute h-[calc(100%-8px)] top-1 rounded-full bg-white/10 shadow-[0_0_10px_rgba(255,255,255,0.1)] transition-all duration-500 opacity-0 pointer-events-none"></div>
            {navItems.map((item) => (
                <li class="relative z-10">
                    <a href={item.url} data-target={item.label} class="nav-link block px-5 py-2 text-sm font-medium text-gray-400 rounded-full transition-colors duration-300 hover:text-white" onmouseenter="moveIndicator(this)">
                        {item.name}
                    </a>
                </li>
            ))}
        </ul>
    </div>

    <div class="flex items-center gap-4 z-10">
      <a href={getLink("#contacto")} class="hidden md:inline-flex group relative items-center justify-center px-6 py-2 text-sm font-bold text-black bg-white rounded-full overflow-hidden transition-transform hover:scale-105 active:scale-95">
        <div class="absolute inset-0 bg-gradient-to-r from-[--color-primary] to-orange-500 opacity-0 group-hover:opacity-100 transition-opacity duration-300 ease-out"></div>
        <span class="relative z-10 flex items-center gap-2 group-hover:text-black transition-colors">{t('nav.contact')}</span>
      </a>
      <div class="md:hidden"><LanguagePicker /></div>
      <button id="menu-toggle" class="md:hidden relative group p-2 text-white focus:outline-none" aria-label="Menu">
          <div class="relative flex overflow-hidden items-center justify-center w-[24px] h-[24px]">
            <div class="flex flex-col justify-between w-[20px] h-[14px] transform transition-all duration-300 origin-center overflow-hidden">
                <div class="bg-white h-[2px] w-7 transform transition-all duration-300 origin-left group-[.expanded]:rotate-[42deg]"></div>
                <div class="bg-white h-[2px] w-1/2 rounded transform transition-all duration-300 group-[.expanded]:-translate-x-10"></div>
                <div class="bg-white h-[2px] w-7 transform transition-all duration-300 origin-left group-[.expanded]:-rotate-[42deg]"></div>
            </div>
          </div>
      </button>
    </div>
  </nav>

  <div id="mobile-menu" class="absolute top-24 left-4 right-4 p-6 bg-[#0A0A0A] border border-white/10 rounded-3xl transform scale-95 opacity-0 pointer-events-none transition-all duration-300 origin-top z-40 flex flex-col gap-4 text-center shadow-2xl">
      {navItems.map((item) => (
        <a href={item.url} class="mobile-link text-xl font-medium text-gray-300 hover:text-[--color-primary] py-3 border-b border-white/5 last:border-0 transition-colors">{item.name}</a>
      ))}
      <a href={getLink("#contacto")} class="mobile-link mt-2 w-full py-4 bg-white text-black font-black rounded-xl hover:bg-gray-200 transition-colors">{t('nav.contact')}</a>
  </div>
</header>

<script is:inline>
  function initNavbar() {
      const navbar = document.getElementById('navbar');
      const indicator = document.getElementById('nav-indicator');
      const menuToggle = document.getElementById('menu-toggle');
      const mobileMenu = document.getElementById('mobile-menu');
      const mobileLinks = document.querySelectorAll('.mobile-link');
      const navUl = document.querySelector('ul');

      // Scroll Logic (Header expandido/contraído)
      const handleScroll = () => {
        if (window.scrollY > 20) {
          navbar?.classList.replace('max-w-4xl', 'max-w-7xl');
          navbar?.classList.replace('bg-black/60', 'bg-[#050505]/90');
          navbar?.classList.add('border-white/15');
        } else {
          navbar?.classList.replace('max-w-7xl', 'max-w-4xl');
          navbar?.classList.replace('bg-[#050505]/90', 'bg-black/60');
          navbar?.classList.remove('border-white/15');
        }
      };
      
      window.removeEventListener('scroll', window.navbarScrollHandler);
      window.navbarScrollHandler = handleScroll;
      window.addEventListener('scroll', window.navbarScrollHandler);
      handleScroll();

      // Indicator Logic
      window.moveIndicator = function(element) {
          if (!indicator || !element) return;
          const parentLi = element.closest('li');
          if (!parentLi) return;
          indicator.style.width = `${parentLi.offsetWidth}px`;
          indicator.style.transform = `translateX(${parentLi.offsetLeft}px)`;
          indicator.style.opacity = '1';
      }
      navUl?.addEventListener('mouseleave', () => { if (indicator) indicator.style.opacity = '0'; });

      // Mobile Menu Logic
      function toggleMobileMenu() {
        menuToggle?.classList.toggle('expanded');
        const isExpanded = menuToggle?.classList.contains('expanded');
        if (isExpanded) {
            mobileMenu?.classList.remove('scale-95', 'opacity-0', 'pointer-events-none');
            mobileMenu?.classList.add('scale-100', 'opacity-100', 'pointer-events-auto');
        } else {
            mobileMenu?.classList.add('scale-95', 'opacity-0', 'pointer-events-none');
            mobileMenu?.classList.remove('scale-100', 'opacity-100', 'pointer-events-auto');
        }
      }
      // Reemplazar listener anterior
      const newMenuBtn = document.getElementById('menu-toggle');
      newMenuBtn?.replaceWith(newMenuBtn.cloneNode(true)); // Truco para limpiar listeners viejos
      document.getElementById('menu-toggle')?.addEventListener('click', toggleMobileMenu);

      mobileLinks.forEach(link => {
          link.addEventListener('click', toggleMobileMenu);
      });
  }
  document.addEventListener('astro:page-load', initNavbar);
</script>