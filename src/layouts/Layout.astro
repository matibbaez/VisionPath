---
// src/layouts/Layout.astro
import { getLangFromUrl } from '../utils/i18n';
import { ClientRouter } from 'astro:transitions'; 
import '../styles/global.css';
import CookieBanner from '../components/CookieBanner.astro';

interface Props {
    title: string;
}

const { title } = Astro.props;
const lang = getLangFromUrl(Astro.url);

const socialImage = new URL('/og-image.png', Astro.site || Astro.url).toString();
---

<!doctype html>
<html lang={lang} class="scroll-smooth overflow-x-hidden">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content="VisionPath | Digital Product Studio. Transformamos complejidad en ventaja competitiva." />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/logoVP.png" />
        <meta name="generator" content={Astro.generator} />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content="VisionPath | Digital Product Studio. Ingeniería de software high-end para marcas globales." />
        <meta property="og:image" content={socialImage} />

        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content="VisionPath | Digital Product Studio. Ingeniería de software high-end para marcas globales." />
        <meta property="twitter:image" content={socialImage} />
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
        
        <title>{title}</title>

        <style is:global>
            /* Lenis solo activo en desktop */
            @media (min-width: 1024px) {
                html.lenis, html.lenis body { height: auto; }
                .lenis.lenis-smooth { scroll-behavior: auto !important; }
                .lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
                .lenis.lenis-stopped { overflow: hidden; }
                .lenis.lenis-scrolling iframe { pointer-events: none; }
            }
        </style>
        <ClientRouter />
    </head>
    
    <body class="font-sans bg-black text-white antialiased overflow-x-hidden w-full max-w-[100vw]">
        <slot />

        <script is:inline src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

        <script is:inline>
            let lenis;
            let animationId;

            function initLenis() {
                // 1. Limpieza
                if (lenis) {
                    lenis.destroy();
                    lenis = null;
                }
                if (animationId) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                }

                // 2. DETECTOR DE MOBILE: Si es pantalla chica, NO iniciamos Lenis
                if (window.innerWidth < 1024) { 
                    return; 
                }

                // 3. Iniciar Lenis SOLO en Desktop
                lenis = new Lenis({
                    duration: 1.2,
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                    orientation: 'vertical',
                    gestureOrientation: 'vertical',
                    smoothWheel: true,
                    wheelMultiplier: 1,
                    smoothTouch: false, 
                    touchMultiplier: 2,
                });

                function raf(time) {
                    lenis.raf(time);
                    animationId = requestAnimationFrame(raf);
                }
                animationId = requestAnimationFrame(raf);

                // Conectar links internos para Desktop
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        const targetId = this.getAttribute('href');
                        if (targetId === '#' || targetId === '') return;
                        
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            e.preventDefault();
                            lenis.scrollTo(targetId);
                        }
                    });
                });
            }

            // 4. MANEJO DE SCROLL AL CAMBIAR DE PÁGINA
            document.addEventListener('astro:page-load', () => {
                initLenis();

                // Detectar si hay que ir a una sección específica
                const hash = window.location.hash;
                if (hash) {
                    setTimeout(() => {
                        const target = document.querySelector(hash);
                        if (target) {
                            if (lenis) {
                                // Desktop: Salto instantáneo controlado por Lenis
                                lenis.scrollTo(target, { immediate: true, offset: 0 });
                            } else {
                                // Mobile: Salto instantáneo nativo (CORREGIDO AQUÍ)
                                // Usamos 'auto' en vez de 'smooth' para evitar el viaje visual feo
                                target.scrollIntoView({ behavior: 'auto', block: 'start' });
                            }
                        }
                    }, 100); // Pequeño delay para asegurar que el DOM cargó
                } else {
                    // Si no hay hash, asegurar que estamos arriba
                    if (lenis) lenis.scrollTo(0, { immediate: true });
                    else window.scrollTo({ top: 0, behavior: 'auto' });
                }
            });
        </script>
        <CookieBanner />
    </body>
</html>