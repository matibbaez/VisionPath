---
// src/layouts/Layout.astro
import { getLangFromUrl } from '../utils/i18n';
import { ClientRouter } from 'astro:transitions'; 
import '../styles/global.css';

interface Props {
    title: string;
}

const { title } = Astro.props;
const lang = getLangFromUrl(Astro.url);

// Lógica para la imagen absoluta (Necesaria para WhatsApp/LinkedIn)
// Si no hay dominio configurado aún, usa la ruta relativa, pero lo ideal es el dominio completo.
const socialImage = new URL('/og-image.png', Astro.site || Astro.url).toString();
---

<!doctype html>
<html lang={lang} class="scroll-smooth overflow-x-hidden">
    <head>
        <meta charset="UTF-8" />
        <meta name="description" content="VisionPath | Digital Product Studio. Transformamos complejidad en ventaja competitiva." />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" type="image/svg+xml" href="/logoVP.png" />
        <meta name="generator" content={Astro.generator} />
        
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={title} />
        <meta property="og:description" content="VisionPath | Digital Product Studio. Ingeniería de software high-end para marcas globales." />
        <meta property="og:image" content={socialImage} />

        <meta property="twitter:card" content="summary_large_image" />
        <meta property="twitter:url" content={Astro.url} />
        <meta property="twitter:title" content={title} />
        <meta property="twitter:description" content="VisionPath | Digital Product Studio. Ingeniería de software high-end para marcas globales." />
        <meta property="twitter:image" content={socialImage} />
        
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
        
        <title>{title}</title>

        <style is:global>
            html.lenis, html.lenis body { height: auto; }
            .lenis.lenis-smooth { scroll-behavior: auto !important; }
            .lenis.lenis-smooth [data-lenis-prevent] { overscroll-behavior: contain; }
            .lenis.lenis-stopped { overflow: hidden; }
            .lenis.lenis-scrolling iframe { pointer-events: none; }
        </style>
        <ClientRouter />
    </head>
    
    <body class="font-sans bg-black text-white antialiased overflow-x-hidden w-full max-w-[100vw]">
        <slot />

        <script is:inline src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js"></script>

        <script is:inline>
            let lenis;
            let animationId;

            function initLenis() {
                // 1. Limpieza
                if (lenis) lenis.destroy();
                if (animationId) cancelAnimationFrame(animationId);

                // 2. Iniciar Lenis
                lenis = new Lenis({
                    duration: 1.2,
                    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
                    orientation: 'vertical',
                    gestureOrientation: 'vertical',
                    smoothWheel: true,
                    wheelMultiplier: 1,
                    smoothTouch: false,
                    touchMultiplier: 2,
                });

                function raf(time) {
                    lenis.raf(time);
                    animationId = requestAnimationFrame(raf);
                }
                animationId = requestAnimationFrame(raf);

                // 3. Conectar links internos (Smooth Scroll)
                document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                    anchor.addEventListener('click', function (e) {
                        const targetId = this.getAttribute('href');
                        if (targetId === '#' || targetId === '') return;
                        
                        // Solo si el destino existe en esta página (ej: click en Home)
                        const targetElement = document.querySelector(targetId);
                        if (targetElement) {
                            e.preventDefault();
                            lenis.scrollTo(targetId);
                        }
                    });
                });

                // 4. MANEJO DE HASH AL CARGAR LA PÁGINA (La solución al problema)
                // Detectamos si venimos de otra página con un #hash en la URL
                const hash = window.location.hash;
                
                if (hash) {
                    // Si hay hash, esperamos a que el DOM esté listo y saltamos
                    // Usamos 'immediate: true' para que sea instantáneo y no se vea el viaje
                    setTimeout(() => {
                        const target = document.querySelector(hash);
                        if (target) {
                            lenis.scrollTo(target, { immediate: true, offset: 0 });
                        }
                    }, 100); // Pequeño delay técnico necesario
                } else {
                    // Si no hay hash, forzamos ir arriba (para arreglar bug de Astro que recuerda scroll)
                    lenis.scrollTo(0, { immediate: true });
                }
            }

            // Ejecutar en cada navegación
            document.addEventListener('astro:page-load', initLenis);
        </script>
    </body>
</html>